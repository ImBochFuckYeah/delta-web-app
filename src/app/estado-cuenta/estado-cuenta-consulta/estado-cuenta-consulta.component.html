<div class="container-fluid mt-4">
  <h2>Estado de Cuenta - Consulta y Reporte</h2>

  <!-- Sección de Filtros -->
  <div class="card mb-4">
    <div class="card-header">
      <i class="fas fa-search me-2"></i>
      Criterios de Búsqueda
    </div>
    <div class="card-body">
      <div class="row">
        <!-- ID Cuenta -->
        <div class="col-md-3">
          <div class="mb-3">
            <label class="form-label">ID Cuenta</label>
            <input
              type="number"
              class="form-control"
              [(ngModel)]="filtros.IdSaldoCuenta"
              placeholder="Ej: 1001"
              [disabled]="loading">
          </div>
        </div>

        <!-- ID Cliente -->
        <div class="col-md-3">
          <div class="mb-3">
            <label class="form-label">ID Cliente</label>
            <input
              type="number"
              class="form-control"
              [(ngModel)]="filtros.IdPersona"
              placeholder="Ej: 500"
              [disabled]="loading">
          </div>
        </div>

        <!-- Nombre -->
        <div class="col-md-3">
          <div class="mb-3">
            <label class="form-label">Nombre</label>
            <input
              type="text"
              class="form-control"
              [(ngModel)]="filtros.Nombre"
              placeholder="Nombre del cliente"
              [disabled]="loading">
          </div>
        </div>

        <!-- Apellido -->
        <div class="col-md-3">
          <div class="mb-3">
            <label class="form-label">Apellido</label>
            <input
              type="text"
              class="form-control"
              [(ngModel)]="filtros.Apellido"
              placeholder="Apellido del cliente"
              [disabled]="loading">
          </div>
        </div>
      </div>

      <div class="row">
        <!-- Fecha Desde -->
        <div class="col-md-3">
          <div class="mb-3">
            <label class="form-label">Desde</label>
            <input
              type="date"
              class="form-control"
              [(ngModel)]="filtros.Desde"
              [disabled]="loading">
          </div>
        </div>

        <!-- Fecha Hasta -->
        <div class="col-md-3">
          <div class="mb-3">
            <label class="form-label">Hasta</label>
            <input
              type="date"
              class="form-control"
              [(ngModel)]="filtros.Hasta"
              [disabled]="loading">
          </div>
        </div>
      </div>

      <!-- Botones de acción -->
      <div class="row">
        <div class="col-12">
          <button
            class="btn btn-primary me-2"
            (click)="buscar()"
            [disabled]="loading">
            <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
            Buscar
          </button>
          <button
            class="btn btn-secondary"
            (click)="limpiar()"
            [disabled]="loading">
            Limpiar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Mensajes -->
  <div *ngIf="mensaje" class="alert" [ngClass]="{
    'alert-success': tipoMensaje === 'success',
    'alert-danger': tipoMensaje === 'error',
    'alert-info': tipoMensaje === 'info'
  }" role="alert">
    <i class="fas" [ngClass]="{
      'fa-check-circle': tipoMensaje === 'success',
      'fa-exclamation-circle': tipoMensaje === 'error',
      'fa-info-circle': tipoMensaje === 'info'
    }" class="me-2"></i>
    {{ mensaje }}
  </div>

  <!-- Resultados -->
  <div *ngIf="mostrarResultados && header" class="results-section">
    <!-- Encabezado del Cliente -->
    <div class="card mb-3">
      <div class="card-header bg-primary text-white">
        <i class="fas fa-user me-2"></i>
        Información del Cliente
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <p><strong>Cliente:</strong> {{ header.Nombre }} {{ header.Apellido }}</p>
            <p><strong>ID Cliente:</strong> {{ header.IdPersona }}</p>
            <p><strong>ID Cuenta:</strong> {{ header.IdSaldoCuenta }}</p>
          </div>
          <div class="col-md-6">
            <p><strong>Tipo de Cuenta:</strong> {{ header.TipoCuenta }}</p>
            <p><strong>Estado:</strong>
              <span class="badge" [ngClass]="header.StatusCuenta === 'Activa' ? 'bg-success' : 'bg-secondary'">
                {{ header.StatusCuenta }}
              </span>
            </p>
            <p><strong>Correo:</strong> {{ header.CorreoElectronico || 'N/A' }}</p>
            <p><strong>Teléfono:</strong> {{ header.Telefono || 'N/A' }}</p>
          </div>
        </div>
        <div class="row mt-2">
          <div class="col-md-12">
            <p><strong>Período:</strong>
              {{ formatearFechaLegible(header.PeriodoDesde) }} - {{ formatearFechaLegible(header.PeriodoHasta) }}
            </p>
            <p><strong>Saldo Anterior:</strong>
              <span class="fw-bold" [ngClass]="header.SaldoAnterior >= 0 ? 'text-success' : 'text-danger'">
                {{ formatearMoneda(header.SaldoAnterior) }}
              </span>
            </p>
            <p><strong>Saldo Inicial del Período:</strong>
              <span class="fw-bold" [ngClass]="header.SaldoInicialPeriodo >= 0 ? 'text-success' : 'text-danger'">
                {{ formatearMoneda(header.SaldoInicialPeriodo) }}
              </span>
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Botones de acción -->
    <div class="mb-3 text-end">
      <button
        class="btn btn-success me-2"
        (click)="exportarCsv()"
        [disabled]="loading">
        <i class="fas fa-file-excel me-2"></i>
        Exportar Excel
      </button>
      <button
        class="btn btn-info"
        (click)="imprimir()"
        [disabled]="loading">
        <i class="fas fa-print me-2"></i>
        Vista de Impresión
      </button>
    </div>

    <!-- Tabla de Movimientos -->
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Tipo de Movimiento</th>
            <th>Documento Ref.</th>
            <th class="text-end">Cargo</th>
            <th class="text-end">Abono</th>
            <th class="text-end">Saldo Acumulado</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of items">
            <td>{{ formatearFechaLegible(item.FechaMovimiento) }}</td>
            <td>{{ item.TipoMovimiento }}</td>
            <td>{{ item.DocumentoRef || '-' }}</td>
            <td class="text-end">
              <span *ngIf="item.Cargo > 0" class="text-danger">
                {{ formatearMoneda(item.Cargo) }}
              </span>
              <span *ngIf="item.Cargo === 0">-</span>
            </td>
            <td class="text-end">
              <span *ngIf="item.Abono > 0" class="text-success">
                {{ formatearMoneda(item.Abono) }}
              </span>
              <span *ngIf="item.Abono === 0">-</span>
            </td>
            <td class="text-end fw-bold" [ngClass]="item.SaldoAcumulado >= 0 ? 'text-success' : 'text-danger'">
              {{ formatearMoneda(item.SaldoAcumulado) }}
            </td>
          </tr>
          <tr *ngIf="items.length === 0">
            <td colspan="6" class="text-center">No se encontraron movimientos</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Totales -->
    <div *ngIf="totales" class="card mt-3">
      <div class="card-header bg-secondary text-white">
        <i class="fas fa-calculator me-2"></i>
        Resumen del Período
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-3">
            <p class="mb-1"><strong>Saldo Inicial:</strong></p>
            <p class="h5" [ngClass]="totales.SaldoInicial >= 0 ? 'text-success' : 'text-danger'">
              {{ formatearMoneda(totales.SaldoInicial) }}
            </p>
          </div>
          <div class="col-md-3">
            <p class="mb-1"><strong>Total Cargos:</strong></p>
            <p class="h5 text-danger">{{ formatearMoneda(totales.TotalCargos) }}</p>
          </div>
          <div class="col-md-3">
            <p class="mb-1"><strong>Total Abonos:</strong></p>
            <p class="h5 text-success">{{ formatearMoneda(totales.TotalAbonos) }}</p>
          </div>
          <div class="col-md-3">
            <p class="mb-1"><strong>Saldo Final:</strong></p>
            <p class="h5 fw-bold" [ngClass]="totales.SaldoFinal >= 0 ? 'text-success' : 'text-danger'">
              {{ formatearMoneda(totales.SaldoFinal) }}
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Spinner de carga -->
  <div *ngIf="loading" class="text-center mt-3">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <p class="mt-2">Procesando solicitud...</p>
  </div>
</div>
